import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import LabelEncoder
from sklearn.metrics import classification_report
import joblib

# Load dataset
df = pd.read_excel("loan_features_tables.xlsx")

# Define categorical columns
label_columns = ['Voters Card', 'BVN', 'Tax Invoice', 'Tax Clearance Cert', 'Invest Freq', 
                 'Borrowed Money', 'Debt', 'Own Agri Land', 'Own Agri Mech Tool', 
                 'Gender', 'Drought Damage', 'Pest Infestation', 'Source of Income']

# Manually encode 'Invest Freq' as target
invest_freq_mapping = {
    "Do not save": 0,
    "Sometimes": 1,
    "Always": 2
}
df['Invest Freq'] = df['Invest Freq'].map(invest_freq_mapping)

# Apply label encoding to remaining categorical columns (independently)
for col in label_columns:
    if col != 'Invest Freq':  # Already encoded manually
        le = LabelEncoder()
        df[col] = le.fit_transform(df[col])

# Map income levels to ordinal scale
income_mapping = {
    'No income': 0,
    'Below N15,000 per month': 1,
    'N15,001 - N35,000 per month': 2,
    'N35,001 - N55,000 per month': 3,
    'N55,001 - N75,000 per month': 4,
    'N75,001 - N95,000 per month': 5,
    'N95,001 - N115,000 per month': 6,
    'N115,001 - N135,000 per month': 7,
    'N135,001 - N155,000 per month': 8,
    'N155,001 - N175,000 per month': 9,
    'N175,001 - N195,000 per month': 10,
    'N195,001 - N215,000 per month': 11,
    'N215,001 - N235,000 per month': 12,
    'N235,001 - N255,000 per month': 13,
    'N255,001 - N275,000 per month': 14,
    'N275,001 - 295,000 per month': 15,
    'N295,001 - N315,000 per month': 16,
    'Above N315,000 per month': 17
}
df['Avg Income Level'] = df['Avg Income Level'].map(income_mapping)

# Set features and target
X = df.drop('Invest Freq', axis=1)
y = df['Invest Freq']

# Split dataset
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Train model
model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

# Save model
joblib.dump(model, 'model.pkl')

# Evaluate model
y_pred = model.predict(X_test)
print("Model classification report:\n")
print(classification_report(y_test, y_pred))
